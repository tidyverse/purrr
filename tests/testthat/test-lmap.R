test_that("lmap output is list if input is list", {
  expect_bare(lmap(as.list(mtcars), as.list), "list")
  skip_if_not_installed("tidyselect")
  x <- list(a = 1:4, b = letters[5:7], c = 8:9, d = letters[10])
  maybe_rep <- function(x) {
    n <- rpois(1, 2)
    out <- rep_len(x, n)
    if (length(out) > 0) {
      names(out) <- paste0(names(x), seq_len(n))
    }
    out
  }
  expect_bare(lmap_at(x, vars(tidyselect::contains("a")), maybe_rep), "list")
})

test_that("lmap() can increase and decrease elements", {
  out <- lmap(list(0, 1, 2), ~ as.list(rep(.x, .x)))
  expect_equal(out, list(1, 2, 2))
})

test_that("lmap_at() only affects selected elements", {
  out <- lmap_at(list(0, 1, 2), c(1, 3), ~ as.list(rep(.x, .x)))
  expect_equal(out, list(1, 2, 2))

  out <- lmap_at(list(0, 1, 2), c(2, 3), ~ as.list(rep(.x, .x)))
  expect_equal(out, list(0, 1, 2, 2))
})

test_that("lmap_at can use tidyselect", {
  skip_if_not_installed("tidyselect")
  x <- lmap_at(mtcars, vars(tidyselect::contains("vs")), ~ .x + 10)
  expect_equal(x$vs[1], 10)
})

test_that("`.else` preserves false elements", {
  x <- list("a", 99)
  out <- lmap_if(x, is.character, ~ list(1, 2), .else = ~ list(3, 4))
  expect_equal(out, list(1, 2, 3, 4))
})

test_that("generates informative error output isn't a list", {
  expect_snapshot(error = TRUE, {
    lmap(list(1), ~ 1)
  })
})
